<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.great.dao.ContractManagerDao">
      <!-- 作者：czk -->
      <!-- 说明：获取所有客户数量 -->
	<select id="getContractCount" resultType="String">
		select 
		count(*) 
		from TB_BUS_PAXYD
		<where>

            <if test="@com.great.util.Ognl@isNotEmpty(condition.name)"> name like "%"#{condition.name}"%"  </if>
             <if test="@com.great.util.Ognl@isNotEmpty(condition.applicantTel)">and applicantTel like "%"#{condition.applicantTel}"%"  </if>
             
             <if test="@com.great.util.Ognl@isNotEmpty(condition.customerState)">
            <if test="condition.customerState=='otherCustomerState' ">and checkState !=5 and checkState !=6 </if>
            <if test="condition.customerState!='otherCustomerState' "> and checkState =#{condition.customerState}  </if>
            </if>
             
            <if test="@com.great.util.Ognl@isNotEmpty(condition.busSpeed)">
            <if test="condition.busSpeed=='otherBusSpeed'">and checkState !=0 and checkState !=1 and checkState !=2 and checkState !=3  </if>
            <if test="condition.busSpeed!='otherBusSpeed'">and checkState =#{condition.busSpeed}  </if>
            </if>
            
            <if test="@com.great.util.Ognl@isNotEmpty(condition.applyDateStart)">and applyDate &gt;= #{condition.applyDateStart}  </if>
            <if test="@com.great.util.Ognl@isNotEmpty(condition.applyDateEnd)">and applyDate &lt;= #{condition.applyDateEnd}  </if> 
        </where>
        ORDER BY applyDate DESC
	</select>
      <!-- 作者：czk -->
      <!-- 说明：带条件、分页查询客户信息 -->
	<select id="getContractList" resultMap="resultListContractBus">
		select 
		*
		from TB_BUS_PAXYD  
		<where>
            <if test="@com.great.util.Ognl@isNotEmpty(condition.name)">name like "%"#{condition.name}"%"  </if>
            <if test="@com.great.util.Ognl@isNotEmpty(condition.applicantTel)">and applicantTel like "%"#{condition.applicantTel}"%"  </if>
            
            <if test="@com.great.util.Ognl@isNotEmpty(condition.customerState)">
            <if test="condition.customerState=='otherCustomerState' ">and checkState !=5 and checkState !=6 </if>
            <if test="condition.customerState!='otherCustomerState' "> and checkState =#{condition.customerState}  </if>
            </if>
            
            <if test="@com.great.util.Ognl@isNotEmpty(condition.busSpeed)">
            <if test="condition.busSpeed=='otherBusSpeed'">and checkState !=0 and checkState !=1 and checkState !=2 and checkState !=3  </if>
            <if test="condition.busSpeed!='otherBusSpeed'">and checkState =#{condition.busSpeed}  </if>
            </if>
            
            <if test="@com.great.util.Ognl@isNotEmpty(condition.applyDateStart)">and applyDate &gt;= #{condition.applyDateStart}  </if>
            <if test="@com.great.util.Ognl@isNotEmpty(condition.applyDateEnd)">and applyDate &lt;= #{condition.applyDateEnd}  </if> 
        </where>
        ORDER BY applyDate DESC
		limit #{queryInitCount}  , #{limit}
	</select>
	
	<resultMap type="com.great.model.BusPAXYDModel" id="resultListContractBus">
	<id column="paxydBusId" property="paxydBusId"/>
	<result column="userId" property="userId"/>
	<result column="salesManId" property="salesManId"/>
	<result column="contractManId" property="contractManId"/>
	<result column="loanAmount" property="loanAmount"/>
	<result column="loanTerm" property="loanTerm"/>
	<result column="accrualType" property="accrualType"/>
	<result column="accrualRate" property="accrualRate"/>
	<result column="checkState" property="checkState"/>
	<result column="applyDate" property="applyDate"/>
	<result column="loanStartDate" property="loanStartDate"/>
	<result column="loanEndDate" property="loanEndDate"/>
	<result column="housingLoanType" property="housingLoanType"/>
	<result column="housingLoanTerm" property="housingLoanTerm"/>
	<result column="warrantyType" property="warrantyType"/>
	<result column="warrantyTerm" property="warrantyTerm"/>
	<result column="warrantyCount" property="warrantyCount"/>
	<result column="accumulationFundAddress" property="accumulationFundAddress"/>
	<result column="accumulationFundTerm" property="accumulationFundTerm"/>
	<result column="accumulationFundAmount" property="accumulationFundAmount"/>
	<result column="ownBusinessLicense" property="ownBusinessLicense"/>
	<result column="name" property="name"/>
	<result column="age" property="age"/>
	<result column="sex" property="sex"/>
	<result column="applicantTel" property="applicantTel"/>
	<result column="applicantJob" property="applicantJob"/>
	<result column="applicatExpectLoanAccount" property="applicatExpectLoanAccount"/>
	<result column="salesManRemarkAndAdvice" property="salesManRemarkAndAdvice"/>
	<result column="salesManAdviceProduct" property="salesManAdviceProduct"/>
	<result column="contractManRemarkAndAdvice" property="contractManRemarkAndAdvice"/>
	<result column="finalProduct" property="finalProduct"/>
	<result column="applyFailReason" property="applyFailReason"/>
	<result column="applyRefuseReason" property="applyRefuseReason"/>
	<result column="type" property="type"/>
	<association property="userModel" column="userId"  javaType="com.great.model.UserModel"  select="queryUserById"/>
	<association property="salesManModel" column="salesManId"  javaType="com.great.model.UserModel"  select="queryManagerById"/>
	<association property="contractManModel" column="contractManId"  javaType="com.great.model.UserModel"  select="queryManagerById"/>
	<association property="contractManName" column="contractManId"  javaType="java.lang.String"  select="queryManagerNameById"/>
	 </resultMap>
      <!-- 作者：czk -->
      <!-- 说明：删除客户信息 -->
	<insert id="deleteUserInfo"  parameterType="java.lang.Integer">
	UPDATE 
	TB_USER 
	SET 
	delState = 1
	where userId=#{deleteUserId}
	</insert>
	
      <!-- 作者：czk -->
      <!-- 说明：添加单笔客户信息 -->
	<insert id="addContractBusInfo" parameterType="com.great.model.BusPAXYDModel">
	INSERT INTO 
	TB_BUS_PAXYD
	(contractManId,
	type,applyDate,name,sex,applicantTel,applicantJob,applicatExpectLoanAccount,
	housingLoanType,housingLoanTerm,
	warrantyType,warrantyTerm,warrantyCount,
	accumulationFundAddress,accumulationFundTerm,accumulationFundAmount,
	ownBusinessLicense,
	checkState) 
	
	values 
	
	(#{contractManId},
	#{type},#{applyDate},#{name},#{sex},#{applicantTel},#{applicantJob},#{applicatExpectLoanAccount},
	#{housingLoanType},#{housingLoanTerm},
	#{warrantyType},#{warrantyTerm},#{warrantyCount},
	#{accumulationFundAddress},#{accumulationFundTerm},#{accumulationFundAmount},
	#{ownBusinessLicense},
	#{checkState})
	</insert>
	
      <!-- 作者：czk -->
      <!-- 说明：编辑客户信息 -->
	<insert id="contractBusHandle" parameterType="com.great.model.BusPAXYDModel">
	UPDATE 
	TB_BUS_PAXYD 
	SET 
	checkState = #{checkState},
	salesManId = #{salesManId},
	contractManId = #{contractManId},
	type = #{type},
	applyDate = #{applyDate},
	name = #{name},
	sex = #{sex},
	applicantJob=#{applicantJob},
	applicantTel = #{applicantTel},
	applicatExpectLoanAccount = #{applicatExpectLoanAccount},
	housingLoanType = #{housingLoanType},
	housingLoanTerm = #{housingLoanTerm},
	warrantyType = #{warrantyType},
	warrantyTerm = #{warrantyTerm},
	warrantyCount = #{warrantyCount},
	accumulationFundAddress = #{accumulationFundAddress},
	accumulationFundTerm = #{accumulationFundTerm},
	accumulationFundAmount = #{accumulationFundAmount},
	ownBusinessLicense = #{ownBusinessLicense},
	salesManAdviceProduct = #{salesManAdviceProduct},
	salesManRemarkAndAdvice = #{salesManRemarkAndAdvice},
	contractManRemarkAndAdvice = #{contractManRemarkAndAdvice},
	applyFailReason = #{applyFailReason},
	applyRefuseReason = #{applyRefuseReason},
	loanStartDate = #{loanStartDate},
	finalProduct = #{finalProduct},
	loanAmount = #{loanAmount},
	repaymentDate=#{repaymentDate}
	WHERE
	paxydBusId = #{paxydBusId}
	</insert>
	   <!-- 作者：czk -->
      <!-- 说明：接待客户 -->
	<insert id="receiveCustomer" parameterType="com.great.model.BusPAXYDModel">
	UPDATE 
	TB_BUS_PAXYD 
	SET 
	checkState = 4
	WHERE 
	paxydBusId = #{paxydBusId}
	</insert>
			<!-- 作者：czk -->
      <!-- 说明：查看还款日  -->
 	<select id="showAllRepaymentDate"   resultMap="resultListContractBus">
		select 
		*
		from TB_BUS_PAXYD
<!--  		<where>
		checkState = 2
        </where> -->
	</select>
		<!-- 作者：czk -->
      <!-- 说明：查询业务 通过id  -->
 	<select id="queryBusById"  parameterType="java.lang.Integer"  resultMap="resultListContractBus">
		select 
		*
		from TB_BUS_PAXYD
		<where>
		paxydBusId = #{paxydBusId}
        </where>
	</select>
      <!-- 作者：czk -->
      <!-- 说明：验证手机号是否存在 -->
	<select id="verifyUserPhone" resultType="String">
		select 
		count(*) 
		from TB_USER
		<where>
		userType=1 and
		delState=0
            <if test="userPhone!=null">and uPhone = #{userPhone}</if>
        </where>
	</select>
	  <!-- 作者：czk -->
      <!-- 说明：通过userId获取客户信息 -->
 	<select id="queryUserById"  parameterType="java.lang.Integer"  resultType="com.great.model.UserModel">
		select 
		* 
		from TB_USER
		<where>
		userType=1 and
		delState=0 and 
        userId = #{userId} 
        </where>
	</select>
	
	<!-- 作者：czk -->
      <!-- 说明：通过userId获取客户经理、签约经理信息 -->
 	<select id="queryManagerById"  parameterType="java.lang.Integer"  resultType="com.great.model.UserModel">
		select 
		* 
		from TB_USER
		<where>
		userType=2 and
		delState=0 and 
        userId = #{userId} 
        </where>
	</select>
		<!-- 作者：czk -->
      <!-- 说明：通过userId获取客户经理、签约经理mingzi  -->
 	<select id="queryManagerNameById"  parameterType="java.lang.Integer"  resultType="java.lang.String">
		select 
		userName
		from TB_USER
		<where>
		userType=2 and
		delState=0 and 
        userId = #{userId} 
        </where>
	</select>
</mapper>
